<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="keywords" content="Raaz, Cryptography, Haskell" />
    
    
    
    
    <meta name="generator" content="pandoc" />
    <link href="//fonts.googleapis.com/css?family=Tangerine:700" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link href="../stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <link href="../stylesheets/font-awesome/font-awesome.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <title>Piyush P Kurur|Adventures in optimising ChaCha20 for Raaz.</title>
  </head>
  <body>
    <div id="root" class="page">
  <div class="header">
    <h1>Piyush P Kurur</h1>
    <div class="navigation">
      <!-- Add your navigation menu here !-->
<ul>
<li><a href="../" title="Home"><i class="fa fa-home"></i></a></li>
<li><a href="../posts/feeds/atom.xml"><i class="fa fa-rss"></i></a></li>
<li><a href="../contact/" title="Contact"><i class="fa fa-envelope"></i></a></li>
<li><a href="https://github.com/piyush-kurur" title="On GitHub"><i class="fa fa-github"></i></a></li>
<li><a href="https://bitbucket.org/piyush-kurur" title="On BitBucket"><i class="fa fa-bitbucket"></i></a> <!--

[<i class="icon-legal " title="Legalese"/>](/legal/)

[<i class="icon-archive " title="Archive"/>](/posts/archive/)
--></li>
</ul>
    </div>
  </div>
  <div class="main-content">
    <span class="post-tags"><i class="fa fa-tags"></i><a href="../posts/tags/Raaz.html">Raaz</a>, <a href="../posts/tags/Cryptography.html">Cryptography</a>, <a href="../posts/tags/Haskell.html">Haskell</a></span>
<div class="post">
  <h1 id="post-title">Adventures in optimising ChaCha20 for Raaz.</h1>
  <span class="post-date">February  6, 2017 (Monday)</span>

  <a href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent(window.location); return false" alt="submit to reddit" border="0">
    <span class="reddit">
      <i class="fa fa-reddit-square fa-lg"></i> reddit this
    </span>
  </a>
  <br />
    <p>In this post, I note down some of the things I learned while optimising ChaCha20 implementation in the Raaz library.</p>
<p><strong>TLDR:</strong> Do not waste time on hand optimising when there is GCC, the beast from the savanna.</p>
<h2 id="a-brief-description-of-the-chacha20">A brief description of the ChaCha20</h2>
<p>We have a chacha state which is essentially a 4x4 matrix of 32-bit unsigned word (<code>Word32</code> in Haskell). The main body of the chacha transform consists of performing a quarter round, QROUND from now on, first on all the rows of the matrix and then on each of the diagonals of the matrix. For example, if the matrix is</p>
<pre><code>	x0  x4  x8   x12
	x1  x5  x9   x13
	x2  x6  x10  x14
	x3  x7  x11  x15
</code></pre>
<p>Then a single round of ChaCha20 is the following operations.</p>
<pre><code>
	QROUND(x0, x4, x8,  x12); // QROUND(row0)
	QROUND(x1, x5, x9,  x13); // QROUND(row1)
	QROUND(x2, x6, x10, x14); // QROUND(row2)
	QROUND(x3, x7, x11, x15); // QROUND(row3)


	QROUND(x0, x5, x10, x15); // QROUND(diag0)
	QROUND(x1, x6, x11, x12); // QROUND(diag1)
	QROUND(x2, x7, x8,  x13); // QROUND(diag2)
	QROUND(x3, x4, x9,  x14); // QROUND(diag3)
</code></pre>
<p>The chacha20 stream is generated by performing this row and diagonal transformations 20 times followed by some adding up.</p>
<p>The first step was to get a portable version of ChaCha20 with the associated tests, which was done without much difficulty. You can have a look at it <a href="https://github.com/raaz-crypto/raaz/blob/master/cbits/raaz/cipher/chacha20/cportable.c" class="uri">https://github.com/raaz-crypto/raaz/blob/master/cbits/raaz/cipher/chacha20/cportable.c</a> There was nothing clever here other than making sure that the variables xi’s are declared register.</p>
<h2 id="vector-optimisations">Vector optimisations</h2>
<p>The quarter round essentially consists of only addition and xor. It can easily be seen that the 4-row operations are independent of each other. Similarly the four diagonal operations are independent of each other. If we store each of the rows in a 128-bit vector consisting of 4 <code>Word32</code>’s, then the 4-row QROUND can be performed by a single vector version of QROUND. In other words, if we have the vectors</p>
<pre><code>V0 = {x0,   x1,   x2,   x3 };
V1 = {x4,   x5,   x6,   x7 };
V2 = {x8,   x9,   x10,  x11};
V3 = {x12,  x13,  x14,  x15};


</code></pre>
<p>then the <em>single</em> <code>QROUND(V0,V1,V2,V3)</code> performs the <code>QROUND</code> for all the rows. For the diagonal ones we need to shift <code>V1</code>,<code>V2</code>, and <code>V3</code> by 1, 2, and 3 positions to the left respectively and perform a <em>single</em> <code>QROUND(V0,V1,V2,V3)</code> again.</p>
<p>The optimisation for 256-bit vector instructions is similar, but we have to do 2-chacha blocks at a time. This is possible because the two chacha20 blocks differ only by a counter and can be done in parallel.</p>
<p>With the above optimisations I wrote two versions, one using the 128-bit vector the other using 256-bit version using the support for vector types in GCC. Again the implementation was delightfully simple, in fact in many ways much simpler than the portable one because now we can use vector types. The result of these optimisations were not very impressive though.</p>
<ol style="list-style-type: decimal">
<li><p>The performance of 128-bit vector version as compared to the portable version does not improve at all (actually it is slightly worse) instead of the expected 2x improvement.</p></li>
<li><p>The performance of 256-bit version with avx2 is better than the portable one by roughly a factor of 2x where as the naive expectations are a 4x improvement<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>.</p></li>
</ol>
<p>I did look at the generate assembly and the code looked much like what was expected. The 128-bit code was using <code>%xmm</code> registers as expected and the 256-bit version was using the <code>%ymm</code> registers.</p>
<h2 id="letting-the-beast-loose.">Letting the beast loose.</h2>
<p>Cabal install and stack compiles C code with <code>-O2</code>. Just to see what has GCC got under its hood, I compiled stuff with the flags <code>-O3</code> and what a surprise/shock I had. The portable C started competing with the 256-bit implementation. The generated assembly had the SIMD registers in it. Encouraged, I decided to throw in the <code>-march=native</code> and the figures blew me off. The portable C implementation was giving me an insane 14.4 Gbps where as the 256-bit one was only giving me 9.55Gbps.</p>
<h2 id="final-tweaking-and-cabal-flags.">Final tweaking and Cabal flags.</h2>
<p>I can make two assumptions on the the message blocks because they are used only through FFI. Firstly, I can assume that the message block is 32-byte (256-bit) aligned by making sure that the Haskell stub function only passes 32-byte aligned buffers to the portable C implementation. Implementations of primitives in Raaz are instances of the <code>BlockAlgorithm</code> class. All I need to do is to ensure is that <code>bufferStartAlignment</code> is 32 for portable C implementation as opposed to word alignment. I can also assume that the pointer is not aliased. This two tweaks gives only minor improvements and need not be included at all.</p>
<p>The final performance figures are available at:</p>
<p><a href="https://gist.github.com/piyush-kurur/93955e669ab72a51996590bfc106677d" class="uri">https://gist.github.com/piyush-kurur/93955e669ab72a51996590bfc106677d</a></p>
<p>The cabal package now has two flags <code>opt-native</code> and <code>opt-vectorise</code> which results in adding the flags <code>-O2 -ftree-vectorize -march=native</code>. These are not enabled by default but can be enabled if you are compiling for yourself. With these changes there is no more a need for the vector implementations. I am keeping it for historical records.</p>
<h2 id="who-should-not-enable-the-above-flags">Who should not enable the above flags?</h2>
<p>If you are cross compiling, for example, when you are compiling the code for packaging for a distro, it is not advisable to enable these flags. Note that the native in this case would mean the machine on which it is compiled and not on the one where it is run. There is not much of an advantage in the hand coded vector implementation either because one cannot make assumptions on the target.</p>
<p>If you know that your target machine supports vector instructions, you can vectorise with <code>-O2 -ftree-vectorize</code>. Throw in an <code>-mavx2</code>, if you are sure of its supported on the target, and get most of the performance described above. This would be the use case when you are compiling on your local machine but deploying on the cloud for example.</p>
<p><strong>Update:</strong> I got rid of the <code>restrict</code> key word in the portable c file because not all GCC versions seem to be familiar with it.</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>The naive expectation will not hold because of some vector overheads. [compilers]: <a href="https://bitbucket.org/piyush-kurur/compilers" class="uri">https://bitbucket.org/piyush-kurur/compilers</a> “Compilers” [ppt]: </teaching> “Programs, Proofs and Types”<a href="#fnref1">↩</a></p></li>
</ol>
</div>
</div>

<div class="post-comments">
  <div id="disqus_thread"></div>
</div>

<script type="text/javascript">
  var disqus_shortname  = 'piyushkurur';  // required: Short name.
  var disqus_url        = 'http://cse.iitk.ac.in/users/ppk/posts/2017-02-06-Adventures-in-optimising-chacha20.html';
                          // The url of this page
  var disqus_title      = 'Adventures in optimising ChaCha20 for Raaz.';      // The title of this post
  var disqus_identifier = '2017-02-06-Adventures-in-optimising-chacha20';  // The id of this post

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

  </div>
  <div id="powered-by-footer"></div>
</div>
<div id="powered-by">
  Powered by: <a href="http://jaspervdj.be/hakyll">Hakyll</a>,
  <a href="http://compass-style.org"> Compass</a> and
  <a href="http://fontawesome.io"><i class="fa fa-flag"></i> Fontawesome</a>
</div>

  </body>
</html>
